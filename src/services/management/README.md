# Низкоуровневая логика

![IMPORTANT]
В данном каталоге представлены основные файлы по низкоуровневому взаимодействию с контейнерами Amnezia и хостом.

## Структура

- **amnezia_connection.py** - низкоуровневое взаимодействие с Docker-контейнером AmneziaWG
- **base_protocol_service.py** - абстрактный базовый класс для всех протокольных сервисов

## Архитектура поддержки протоколов

Проект построен на модульной архитектуре, позволяющей легко добавлять поддержку новых VPN-протоколов.

### Трехуровневая архитектура

**Уровень 1: Connection (низкоуровневый)**
- Находится в `src/services/management/`
- Отвечает за выполнение команд Docker, чтение/запись файлов в контейнерах
- Пример: `AmneziaConnection`, `XrayConnection`

**Уровень 2: Service (бизнес-логика)**
- Находится в `src/services/`
- Реализует протокол-специфичную логику управления клиентами
- Наследуется от `BaseProtocolService`
- Пример: `AmneziaService`, `XrayService`

**Уровень 3: ClientsService (агрегация)**
- Находится в `src/services/clients_service.py`
- Единая точка входа для работы с клиентами всех протоколов
- Выбирает нужный сервис на основе параметра protocol

## Добавление нового протокола

### Шаг 1: Создать Connection класс

Создайте новый файл в `src/services/management/` с названием протокола, например `xray_connection.py`.

Класс должен предоставлять методы для:
- Выполнения команд внутри Docker-контейнера
- Чтения и записи конфигурационных файлов
- Перезапуска контейнера при необходимости
- Получения специфичных для протокола данных

Используйте `AmneziaConnection` как референс для структуры класса.

### Шаг 2: Создать Service класс

Создайте новый файл в `src/services/` с названием протокола, например `xray_service.py`.

Класс должен:
- Наследоваться от `BaseProtocolService`
- Реализовать все абстрактные методы из базового класса
- Определить property `protocol_name` возвращающий уникальное имя протокола

Обязательные методы для реализации:
- `get_clients()` - получение списка клиентов из контейнера и БД
- `create_client()` - создание нового клиента, генерация ключей, сохранение в БД
- `delete_client()` - удаление клиента из конфига и БД
- `_get_protocol_id()` - получение/создание ID протокола в БД

Внутренние методы определяются на усмотрение разработчика в зависимости от специфики протокола.

### Шаг 3: Зарегистрировать в ClientsService

Откройте файл `src/services/clients_service.py` и добавьте новый сервис в словарь `_services`:

```python
from src.services.xray_service import XrayService

class ClientsService:
    def __init__(self):
        self._services: dict[str, BaseProtocolService] = {
            "amneziawg": AmneziaService(),
            "xray": XrayService(),
        }
```

После регистрации протокол становится доступным через API с параметром protocol.

### Шаг 4: Добавить настройки в Settings

Откройте `src/management/settings.py` и добавьте параметры для нового протокола:

```python
xray_container_name: str = "amnezia-xray"
xray_config_path: str = "/opt/amnezia/xray"
```

Обновите `.env` соответствующими переменными окружения.

## Базовый класс протокола

`BaseProtocolService` определяет единый интерфейс для всех протоколов:

**Абстрактные методы:**
- `protocol_name` - property возвращающий имя протокола
- `get_clients()` - получение списка клиентов
- `create_client()` - создание нового клиента
- `delete_client()` - удаление клиента
- `_get_protocol_id()` - работа с таблицей протоколов в БД

**Реализованные методы:**
- `cleanup_expired_clients()` - автоматическая очистка просроченных клиентов

Все сервисы протоколов должны строго следовать этому содержимому для обеспечения совместимости.